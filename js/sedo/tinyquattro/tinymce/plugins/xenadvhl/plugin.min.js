tinymce.PluginManager.add("xenadvhl",function(n){function l(){var n=this;if(f.adv_hl_active=!f.adv_hl_active,f.adv_hl_active===!1)return n.active(!1),s(),!1;n.active(!0),o(),o()}function s(){n.dom.remove(n.dom.select(".adv_hl"),"adv_hl"),t=0,i=0}function o(){var h;if(f.adv_hl_active===!1)return!1;var e=n.getContent(),u=n.selection,o=!1,s=!1,l=!1,c=!1;r.normalOpen.test(e)&&(o=!0,s=!0,e=e.replace(r.normalOpen,function(n,i,r){var u,f;return t++,u='<span id="advhln_'+t+'" class="adv_hl adv_hln_'+t+'" style="background-color:'+k+'">'+i,typeof r!="undefined"&&(f=i=="[picasa"?/,/gi:/\|/gi,r=r.replace(f,'<span class="adv_hl" style="color:'+v+';font-weight:bolder;">$&</span>'),u+='<span class="adv_hl adv_hln_'+t+" tag_options_"+t+'" style="background-color:'+y+'">'+r+"</span>"),u+="]</span>"})),r.normalClose.test(e)&&(o=!0,s=!0,e=e.replace(r.normalClose,function(n,i){return t++,'<span id="advhln_'+t+'" class="adv_hl adv_hln_'+t+'" style="background-color:'+b+'">'+i+"</span>"})),r.special.test(e)&&(o=!0,l=!0,e=e.replace(r.special,function(n,t,r,u,f){return i++,u||(c=!0),'<span id="advhls_open_'+i+'" class="adv_hl adv_hls_'+i+'" style="background-color:'+w+'">'+t+'</span><span id="advhls_content_'+i+'" class="adv_hl  adv_hls_'+i+'" style="background-color:'+a+'">'+u+'</span><span id="advhls_close_'+i+'" class="adv_hl  adv_hls_'+i+'" style="background-color:'+p+'">'+f+"</span>"})),o&&(n.setContent(e),s===!0&&(u.select(n.dom.select("span#advhln_"+t)[0]),u.setContent(u.getContent())),l===!0&&(c?(u.select(n.dom.select("span#advhls_open_"+i)[0]),h=u.getContent()+'<span id="advhls_content_'+t+'" class="adv_hl adv_hls_'+t+'" style="background-color:'+a+'"><span id="adv_caretfix"></span></span>',u.setContent(h),u.select(n.dom.select("span#adv_caretfix")[0]),u.setContent(u.getContent())):(u.select(n.dom.select("span#advhls_close_"+i)[0]),u.setContent(u.getContent()))))}var f=this,h=xenMCE.Lib.getTools();f.adv_hl_active=!1;var t=0,i=0,u="tags_highlighter",r={};r.normalOpen=/(\[[^\/]+?)((?==)[^\[]*?)?\](?!<[\/]?span)/gi,r.normalClose=/(\[\/([^[]+?)\])(?!<\/span>)/gi,r.special=/(\{([^\/]+?)(?:=.+?)?\})(?!<\/span>)((?:\{\2(?:=.+?)?\}(?:\{\2(?:=.+?)?\}[\s\S]*?\{\/\2\}|[\s\S])+?\{\/\2\}|[\s\S])*?)(\{\/\2\})/gi;var c=h.getParam("adv_hl_norm"),k=c.open,y=c.options,b=c.close,e=h.getParam("adv_hl_spe"),w=e.open,d=e.options,a=e.content,p=e.close,v=h.getParam("adv_hl_tag_separator");n.on("init RestoreDraft",function(){s()});n.on("SaveContent XenSwitchToBbCode SavingXenDraft",function(t){s(),t.content=n.getContent()});n.on("NodeChange keydown",function(){o()});n.addButton(u,{name:u,icon:u,onclick:l}),n.addMenuItem(u,{name:u,selectable:!0,text:"Tags Helper",icon:!1,onClick:l})});