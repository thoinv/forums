/*
 * jQuery PhotoTag plugin 1.3
 *
 * Copyright (c) 2012 Karl Mendes
 * http://karlmendes.com
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Revision:
 * Modified by sonnb to fit XenGallery requirements.
 */

!function(e,t,n,r){e.fn.photoTag=function(n){var r=false;var i={requestTagsUrl:"photo-tags.php",deleteTagsUrl:"delete.php",addTagUrl:"add-tag.php",parametersForNewTag:{username:{parameterKey:"username",label:"Username",_xfToken:""}},parametersForRequest:["image-id","album-id"],literals:{communicationProblem:"Communication problem, your changes could not be saved",saveTag:"Ok",cancelTag:"Cancel",addNewTag:"Add new tag",removeTag:"Remove tag"},tag:{tagIdParameter:"tag_id",defaultWidth:100,defaultHeight:100,cssClass:"photoTag-tag secondaryContent",idPrefix:"photoTag-tag_",showDeleteLinkOnTag:true,deleteLinkCssClass:"photoTag-delete",deleteLinkIdPrefix:"photoTag-delete_",flashAfterCreation:false,newTagFormWidth:106,newTagFormClass:"photoTag-newTagForm"},imageWrapper:".pvContentWrapper",imageWrapBox:{cssClass:"photoTag-wrap",idPrefix:"photoTag-wrap_",addNewLinkIdPrefix:"photoTag-add_",controlPaneIdPrefix:"photoTag-cpanel_",controlPaneCssClass:"photoTag-cpanel",tagListCssClass:"photoTag-list",canvasIdPrefix:"photoTag-canvas_"},externalAddTagLinks:{selector:".addTag"},isEnabledToEditTags:true,manageError:"internal function, user can bind a new one. function(response)",beforeTagRequest:"bind by user, function( parameters )"};var s={tags:{}};var n=e.extend(true,i,n);var o=function(t){var r={};e.each(n.parametersForRequest,function(e,n){var i=t.attr("data-"+n);if(i){r[n]=i}});return r};var u=function(r,i,s){r.mouseover(function(){if(!e.browser.msie){e(this).stop().animate({opacity:1},500)}else{e(this).css({opacity:1})}}).mouseout(function(){if(!e.browser.msie){e(this).stop().animate({opacity:0},500)}else{e(this).css({opacity:0})}});e(t).resize(function(){var t=e("#"+n.tag.idPrefix+"temp",e(n.imageWrapper)),o=s.data("height"),u=s.data("width"),a=s.height(),f=s.width(),l=s.position().top,c=s.position().left,h={top:a/o*i.top+l+"px",left:f/u*i.left+c+"px"};r.css(h).data("width",f/u*i.width).data("height",a/o*i.height);t.data("width",f/u*i.width).data("height",a/o*i.height)})};var a=function(t){if(e.isFunction(n.manageError)){n.manageError(t)}else{if(t.message){console.log(t.message)}}};var f=function(t,r){t.click(function(i){i.preventDefault();var s=t.attr("href").substring(1);var u=o(r);u[n.tag.tagIdParameter]=s;e.getJSON(n.deleteTagsUrl,u,function(e){if(!e.tagList){a(e)}p(e)});e("#"+n.tag.deleteLinkIdPrefix+s).parent().remove()})};var l=function(t,i,s){e(t).click(function(o){o.preventDefault();r=!r;var u=e("#"+n.imageWrapBox.canvasIdPrefix+s,e(n.imageWrapper)),a=e("#"+n.imageWrapBox.idPrefix+s,e(n.imageWrapper)),f=e("#"+n.imageWrapBox.controlPaneIdPrefix+s,e(n.imageWrapper)),l=e(".pwPhotoActions",u),h=e(".caption",u);if(r==false){v();w(s);e(".photo",a).css({cursor:"pointer"});e(".prevPhoto",u).css({visibility:"visible"});e(".nextPhoto",u).css({visibility:"visible"});f.hide();if(h.html()){h.show()}l.show();e("a",f).unbind("click");e(".photo",a).unbind("click")}else{b(s);e(".prevPhoto",u).css({visibility:"hidden"});e(".nextPhoto",u).css({visibility:"hidden"});l.hide();h.hide();f.show();e("a",f).click(function(n){n.preventDefault();e(t).trigger("click");return false});e(".photo",a).css({cursor:"crosshair"}).click(function(t){t.preventDefault();b(s);v();if(e("#"+n.tag.idPrefix+"temp",e(n.imageWrapper)).length==0&&n.addTagUrl){a.append(y(t,i,s));c(e("#"+n.tag.idPrefix+"temp",e(n.imageWrapper)),i,s)}return false});e(XenForo.getPageScrollTagName()).animate({scrollTop:u.offset().top})}return false})};var c=function(e,t,n){h(e,t,n)};var h=function(t,r,i){var s=e("#"+n.imageWrapBox.idPrefix+i,e(n.imageWrapper));var o=e('<form method="POST" id="tempNewTagForm" style="line-height: normal;" action="'+n.addTagUrl+'"></form>');var u=e('<div id="tempTagBoxForm" class="photoTagForm secondaryContent"></div>').hide();u.append(e('<div id="tempNewTagFormContent" class="photoTagContent"></div>'));s.append(u);e("#tempNewTagFormContent").append(o);e.each(n.parametersForNewTag,function(t,n){var r=e('<div><input type="text" class="textCtrl AutoComplete AcSingle" autofocus="true" autocomplete="off" id="tempInput_'+t+'" name="'+n.parameterKey+'" /></div>');if(n.label){var i=e("<label></label>");var s=e("<div/>");i.append(n.label);u.append(i)}o.append(r)});var f=e("<div />");var l=e('<input class="button primary" type="submit" value="'+n.literals.saveTag+'" />');var c=e('<input class="button primary" type="button" value="'+n.literals.cancelTag+'"/>');c.click(function(e){e.preventDefault();v();w(i)});f.append(l).append(c);o.append(f);var h=parseInt(t.css("top"))+t.outerHeight(),d=parseInt(t.css("left")),m=parseInt(t.css("top"))+t.outerHeight();if(h+u.outerHeight(true)>=r.outerHeight()){m=parseInt(t.css("top"))-u.outerHeight()}u.css({top:m,left:d,width:n.tag.newTagFormWidth}).show();o.submit(function(t){t.preventDefault();var s=e("#"+n.tag.idPrefix+"temp",e(n.imageWrapper)),u=r.data("height"),f=r.data("width"),l=r.height(),c=r.width(),h=r.position().top,d=r.position().left,m=r.parent(),y=m.width(),b=m.height();var S={width:s.data("width"),height:s.data("height"),_xfToken:n.parametersForNewTag.username._xfToken,username:e('input[name="username"]',o).val(),_xfNoRedirect:1,_xfResponseType:"json"};if(e("body > div.galleryOverlay").is(":visible")){S.tag_x=s.position().left/(c/f)+d;S.tag_y=s.position().top/(l/u)+h}else{S.tag_x=s.position().left/(c/f)-(y-c)/2;S.tag_y=s.position().top/(l/u)-(b-l)/2}e.post(n.addTagUrl,S,function(t){if(t.result!=undefined&&!t.result){a(t);return}if(!t.tag){return}var s=g(t.tag,r);e("#"+n.imageWrapBox.idPrefix+i,e(n.imageWrapper)).append(s);E(s,t.tag,r,i);p(t)});v();w(i)});XenForo.activate(u)};var p=function(t){e("."+n.imageWrapBox.tagListCssClass,e(n.imageWrapper)).html(t.tagList);XenForo.activate(e("."+n.imageWrapBox.tagListCssClass));e.each(t.image,function(){d(this.tags)})};var d=function(t){e.each(t,function(){var t=n.tag.idPrefix+this.tag_id;e("."+t,e(n.imageWrapper)).mouseover(function(){e("#"+t,e(n.imageWrapper)).trigger("mouseover")}).mouseout(function(){e("#"+t,e(n.imageWrapper)).trigger("mouseout")})})};var v=function(){e("#"+n.tag.idPrefix+"temp",e(n.imageWrapper)).remove();e("#tempTagBoxForm",e(n.imageWrapper)).remove()};var m=function(t,r,i,s){var o=e('<div class="'+n.tag.cssClass+'" data-width="'+r.width+'" data-height="'+r.height+'" id="'+n.tag.idPrefix+t+'"></div>');var u={position:"absolute",top:i.top+"px",left:i.left+"px",opacity:s,height:n.tag.defaultHeight,width:n.tag.defaultWidth};o.css(u);return o};var g=function(t,r){if(!t){return}if(!(t.height&&t.width)){t.height=n.tag.defaultHeight;t.width=n.tag.defaultWidth}var i=r.data("height"),s=r.data("width"),o=r.height(),a=r.width(),l=r.position().top,c=r.position().left,h=r.parent(),p=h.width(),d=h.height();var v={width:a/s*t.width,height:o/i*t.height};if(e("body > div.galleryOverlay").is(":visible")){var g={top:o/i*t.top+l,left:a/s*t.left+c}}else{var g={top:o/i*t.top+(d-o)/2,left:a/s*t.left+(p-a)/2}}if(v.height>n.tag.defaultHeight){v.height=n.tag.defaultHeight}if(v.width>n.tag.defaultWidth){v.width=n.tag.defaultWidth}var y=m(t.tag_id,v,g,0);u(y,t,r);var b=n.tag.idPrefix+t.tag_id;e("."+b).mouseover(function(){e("#"+b,e(n.imageWrapper)).trigger("mouseover")}).mouseout(function(){e("#"+b,e(n.imageWrapper)).trigger("mouseout")});var w=e("<div class='innerTag'></div>");w.append(t.username);y.append(w);if(n.isEnabledToEditTags&&t.isDeleteEnable&&n.tag.showDeleteLinkOnTag&&n.deleteTagsUrl){var E=e('<a id="'+n.tag.deleteLinkIdPrefix+t.tag_id+'" class="'+n.tag.deleteLinkCssClass+'" href="#'+t.tag_id+'"></a>');f(E,r);y.append(E)}return y};var y=function(t,r,i){var o=e("#"+n.imageWrapBox.idPrefix+i,e(n.imageWrapper)),u=r.data("height"),a=r.data("width"),f=r.height(),l=r.width(),c=r.position().top,h=r.position().left,p={width:l/a*n.tag.defaultWidth,height:f/u*n.tag.defaultHeight};var d=t.pageY-r.offset().top-p.height/2+r.position().top,v=t.pageX-r.offset().left-p.width/2+r.position().left;if(d<0){d=0}if(v<0){v=0}var g={top:d,left:v};s.tempId++;var y=m("temp",p,g,1);if(parseInt(y.css("top"))+p.height>=r.outerHeight()+r.position().top){d=r.outerHeight()-p.height+r.position().top}if(parseInt(y.css("top"))<r.position().top){d=r.position().top}if(parseInt(y.css("left"))+p.width>=r.outerWidth()+r.position().left){v=r.outerWidth()-p.width+r.position().left}if(parseInt(y.css("left"))<r.position().left){v=r.position().left}y.css({top:d,left:v});return y};var b=function(t){e.each(s.tags[t],function(){e(this).css({opacity:0});e(this).hide()})};var w=function(t){e.each(s.tags[t],function(){e(this).show()})};var E=function(t,r,i,s){if(n.tag.flashAfterCreation){e(t).css({opacity:1});if(!e.browser.msie){e(t).stop().animate({opacity:0},800)}else{e(t).css({opacity:0})}}};var S=function(t,r){var i=e(n.externalAddTagLinks.selector);i.each(function(){l(this,r,t.content_id)});var o=s.tags[t.content_id]={};if(t.tags){e.each(t.tags,function(){var i=g(this,r);o[this.tag_id]=i;e("#"+n.imageWrapBox.idPrefix+t.content_id,e(n.imageWrapper)).append(i);E(i,this,r,t.content_id)})}};this.each(function(){var t=e(this);var r=o(t);if(!e.isFunction(n.beforeTagRequest)||n.beforeTagRequest(r)){e.getJSON(n.requestTagsUrl,r,function(r){if(r.result!=undefined&&!r.result){a(r);return}if(r.options){n=e.extend(true,n,r.options)}e.each(r.image,function(){S(this,t)})})}});return this}}(jQuery,this,document)